---
layout: post
#slug: accuracy-vs-speed-spatial-analysis
category: analytics
title: "계산 비용과 정확도 사이: 대용량 공간 데이터 처리 전략"
---

### 요약
- 대용량 공간 데이터 처리에서는 계산 비용이 높은 공간 연산을 최소화하여야 한다.
- 관련하여 본 글은 정확한 좌표 정보와 정밀한 버퍼 거리를 희생한 성능 향상 사례를 다룬다.
- 적정 정확도 수준을 파악하는 것이 효율적인 공간 데이터 처리의 출발점이 될 수 있다.

### 1. 대용량 공간 데이터 처리에 대한 기본 접근

공간 연산이 포함된 데이터 처리 능력에 포함된 능력치를 다양한 요소로 나누어 본다면, 역설적이게도 상당히 큰 영역을 차지하는 부분은 공간 연산 자체를 최소화시키는 능력일 것이다. 기본적으로 공간 연산은 계산 비용이 높기 때문에, 수 억 단위 이상의 공간 객체를 다루어야 하는 경우 연산 효율성을 고려해야만 하는 상황이 발생한다.

단발성 분석이라면 시간 소요를 감수할 수 있다. 하지만 실제 데이터 분석 과정은 대부분 반복적이며, 파라미터를 조금씩 조정해가며 여러 차례 시도하는 과정을 피할 수 없다. 만약 각 연산마다 수 시간이 소요된다면 작업 과정의 연속성이 끊기므로, 연산시간 증가분을 초과하는 비효율을 불러올 것이다.

이러한 맥락에서 많은 양의 공간 데이터 처리가 필요한 경우 최대한 공간 연산을 줄일 방법을 고안하여야 한다. 당장 생각나는 접근 방식을 적어보자면 기본적으로 아래와 같다.

```
1. 중복 연산을 최소화한다.
2. 적정 정확도 수준을 결정한다. 꼭 필요하지 않다면 정확도를 일부 희생한다.
3. 가능하다면 공간 조인을 문자열 조인으로 대체한다.
```

이 글은 앞서 제시한 세 가지 접근법이 실제로 적용된 사례를 통해, 대규모 공간 데이터 처리 과정에서 계산 비용과 정확도 사이의 균형을 어떻게 찾아나갔는지 그 사고 과정을 공유하고자 작성하였다. '정확도 조정' 파트가 포함되어 있어 모든 상황에 범용적으로 적용할 수는 없겠지만, 무엇을 포기하고 무엇을 얻는지에 대해 공유할만한 지점이 있다고 생각하였다. 

다음부터 이어질 사례 부분은 Python 환경에서 Polars, Geopandas 등의 라이브러리를 활용하여 분석을 수행했으나, 이 글은 특정 기술 스택보다 문제 해결을 위한 사고 과정과 트레이드오프 결정에 초점을 맞추고자 했으므로 별도의 코드는 남겨두지 않았다. 

## 2. 대중교통 인접성 분석 사례

수천만에서 수억 건에 달하는 유저 위치 정보를 활용해 모든 유저에 대해 대중교통 인접성을 분석하는 상황을 가정해보자. 여기서 '대중교통 인접성'은 사용자의 위치로부터 500m 반경 내에 있는 버스 정류장의 수로 정의한다. 이는 실제 분석 사례를 약간 변형한 시나리오다.

우선 가장 직관적인 접근 방식은 아래와 같을 것이다
```
1. 모든 사용자의 위치를 포인트 자료형으로 불러온다.
2. 모든 포인트에서 500m 버퍼를 생성한다.
3. 해당 버퍼 각각에 대해 포함된 정류장 수를 계산한다.
```

 그러나 수억 포인트 이상의 위치 데이터에 대해 개별적으로 버퍼를 생성하고 정류장 데이터와 공간 조인을 수행하는 것은 현실적인 분석 시간을 초과할 가능성이 높다. 분석 환경에 따라서는 아예 분석 자체가 불가능할 수도 있다. 이에 조금 다른 접근 방식이 필요하다는 생각을 할 수 밖에 없게 된다.

이에 위에서 제시한 관점에 따라서  우선 **중복 연산**을 먼저 찾아본다. 현재 사례에서 발생하는 명백한 중복은 동일한 좌표값을 가진 유저에 대해 같은 연산을 반복한다는 점이다. 조금 더 제약을 느슨하게 풀어 확장시켜 본다면 인접한 유저의 대중교통 인접성이 실질적인 차이가 없는데도 같은 연산이 반복되는 것도 중복으로 볼 수 있다. 

여기에서 **적정 정확도 수준을 결정**하여야 한다. 가령 학술적 성격이 강하여 정확한 500m 반경을 포기할 수 없다면, (분석가의 시간을 포기해서 그냥 다 돌려보는 것도 방법이겠지만) 모든 유저에 대한 분석을 포기한 후, 모든 유저를 잘 대표할 수 있도록 샘플링을 하는 것이 방법일 수 있다. 

정확한 반경 수치가 중요하지 않은 경우 선택지가 생긴다. 어느정도 위치가 비슷한 유저의 대중교통 인접성 수치에 차이가 없다고 할 수 있는 경우, 유저 정보를 포인트 베이스로 볼 것이 아니라 일종의 양자화를 시켜 특정 공간 영역으로 할당시키는 방법이다. 충분히 작은 셀을 사용한다면 정확도 측면에서도 희생을 줄일 수 있다. 포인트 단위 연산을 셀 단위 연산으로 확장시킬 수 있는 상황이라면, 후술하겠지만 이 경우 정류장 수도 셀에 할당하는 양자화가 가능하다.

셀에 할당하는 것은 기본적으로 X, Y 좌표값이 아닌 셀 ID 값을 사용할 수 있다는 것이며, 이에 기반하여 **공간 조인을 문자열 조인으로 대체**할 수 있게 된다. 공간 조인은 기하학적 연산을 기반으로 하기 때문에 계산 비용이 높지만, 문자열 조인은 단순 비교 연산만으로 수행되어 훨씬 효율적이다.

## 3. 분석 전략 수립
### 3.1. 포인트 양자화: H3 그리드 시스템
공간 데이터를 효율적으로 셀에 할당하는 것에는 여러가지 옵션이 있다. 이 경우 버퍼 연산을 대체하는 과정을 포함하므로 사각형 형태의 그리드 보다는 육각형 형태의 H3 그리드 시스템이 적절하다. 

H3는 Uber에서 개발한 오픈소스 라이브러리로, 지구 표면을 유사한 크기의 육각형 셀로 나누는 계층적 공간 인덱싱 시스템이다. H3의 핵심 장점은 다음과 같다:

1. 모든 셀이 유사한 면적을 가져 공간적 왜곡을 최소화한다.
2. 다양한 해상도를 지원하는 계층적 구조를 제공한다.
3. grid_disk 기능을 통해 주변 이웃 셀을 빠르고 쉽게 찾을 수 있다.
4. 육각형 구조로 인해 인접한 셀 간 거리 차이가 사각셀보다 균일하고 작다.

### 3.2. H3의 grid_disk로 버퍼 대체

H3의 기능 중 `grid_disk` 함수는 특정 셀을 중심으로 k단계까지의 모든 이웃 셀을 찾아준다. 여기서 k는 마치 공간적 '껍질'을 몇 겹으로 둘러싸는지를 결정하는 값으로 이해할 수 있다. 

육각형 그리드 시스템의 특성상, grid_disk의 결과는 동심원에 가까운 형태를 띠게 된다. 예를 들어, k=1일 경우 중심 셀을 포함하여 총 7개의 셀(중심 1개 + 주변 6개)을 반환한다. k=2로 설정하면 첫 번째 링의 6개 셀을 둘러싸는 12개의 셀이 추가되어 총 19개 셀(1 + 6 + 12)을 포함하게 된다. 

육각형 구조는 모든 인접 셀 간의 거리가 동일하다는 장점이 있어, 실제 공간상의 거리를 더 균일하게 근사할 수 있다. 따라서 H3의 grid_disk 함수는 전통적인 원형 버퍼의 대안으로 활용될 수 있게 된다. 실제 측정(한국 내 50개 셀 무작위 추출)해본 결과를 보면, 해상도 9에서 우리나라의 단일 셀 평균 면적은 약 75,340m²로, 이는 반지름 약 155m의 원 크기에 해당한다.

grid_disk 1을 사용해서 한 바퀴 감싸는 경우 총 면적은 527,379m²가 되며 이는 반지름 410m의 원과 유사한 면적이다.(크기를 더 정교하게 맞추어야 한다면 셀의 크기를 줄이고 grid_disk 값을 키워 어느정도 대응할 수 있을 것이다.)

만약 500m 대신 410m 정도를 사용해도 크게 문제가 없으며, 인접 지역 판단이 정확히 원이 아니어도 되는 경우 문제는 간단해진다. 이 경우 정류장의 위치 데이터도 사전에 H3 셀로 양자화하여 저장해둘 수 있기 때문에 연산은 극도로 단순해진다.

```
1. 모든 버스 정류장을 H3 셀 ID로 매핑(첫 번째 공간 연산)
2. 각 셀 ID별 정류장 수를 계산
3. 사용자 위치를 H3 셀 ID로 할당(두 번째 공간 연산)
4. grid_disk 함수를 사용하여 이웃 셀 목록 생성
5. 해당 셀들에 포함된 정류장 수의 합계 계산
```

이 과정에서 실제 공간 연산은 최소화되어, 단지 위치 데이터를 셀 ID로 변환하는 과정(1단계와 3단계)에서만 발생한다. 그마저도 단순한 좌표-셀 변환으로 복잡한 기하학적 연산에 비해 연산 부담이 매우 적다.

나머지 과정은 모두 문자열 기반 연산이나 단순 산술 연산으로 이루어진다. 특히 grid_disk 함수는 기하학적 계산 없이 H3의 내부 인덱싱 구조를 활용하여 수학적으로 이웃 셀을 결정하므로, 공간 버퍼 연산과 달리 매우 빠르게 수행된다.

이러한 접근법은 특히 수억 개 이상의 위치 데이터를 처리할 때 그 효과가 극대화된다. 기존 방식대로 각 위치마다 버퍼를 생성하고 공간 조인을 수행하는 대신, 간단한 문자열 조인과 집계 연산만으로 어느정도 유사한 결과를 얻을 수 있기 때문이다.

## 4. 결론: 효율성과 정확도 사이의 균형

모든 문제가 정확한 공간 연산을 필요로 하는 것은 아니다. 데이터 규모가 커질수록, 문제의 본질을 해치지 않는 선에서 적절한 근사치를 활용하는 것이 현실적인 선택이 될 수 있다.

본 글에서 소개한 그리드 시스템을 활용한 접근법은 대용량 공간 데이터 처리에서 정확도와 성능 사이의 실용적인 타협점을 찾는 방법이다. 공간 버퍼 연산과 공간 조인의 높은 연산 비용을 줄이면서도, 분석 목적에 충분한 결과를 얻을 수 있었다. 이러한 최적화는 단순히 일회성 분석의 속도를 높이는 것뿐 아니라, 반복적인 분석과 실험을 가능하게 함으로써 전체 분석 프로세스의 효율성을 크게 향상시켰다.

문제 정의와 요구사항에 대한 명확한 이해는 이러한 접근법의 핵심이다. "500m 내 정류장 수"라는 요구사항에서 "정확히 500m"가 필수적인지, 아니면 "대략 500m 정도"로 충분한지를 판단하는 것이 효율적인 해결책의 출발점이 되었다. 대규모 공간 데이터 분석에서는 필요한 정확도와 허용 가능한 근사치의 경계를 명확히 설정하는 것이 종종 기술적 최적화보다 더 중요한 성공 요소가 될 수 있다.

