---
layout: post
#slug: accuracy-vs-speed-spatial-analysis
category: analytics
title: "계산 비용과 정확도 사이: 대용량 공간 데이터 처리 전략"
---

### 요약
- 대용량 공간 데이터 처리에서는 계산 비용이 높은 공간 연산을 최소화하여야 한다.
- 관련하여 본 글은 정확한 좌표 정보와 정밀한 버퍼 거리를 희생한 성능 향상 사례를 다룬다.
- 적정 정확도 수준을 파악하는 것이 효율적인 공간 데이터 처리의 출발점이 될 수 있다.

## 1. 대용량 공간 데이터 처리에 대한 기본 접근

공간 연산은 기본적으로 계산 비용이 높기 때문에,대용량의 공간 객체를 다루어야 하는 경우 연산 효율성을 고려해야 한다. 단발성 분석이라면 시간 소요를 감수할 수 있지만, 실제 데이터 분석은 대부분 반복적이며 파라미터를 조정해가며 여러 차례 시도하는 과정이 필요하다. 각 연산마다 수 시간이 소요된다면 작업의 연속성이 끊겨 효율성이 크게 저하된다.

대용량 공간 데이터 처리에 있어 효율성을 높이기 위해 나는 기본적으로 아래와 같이 접근해본다.

```
1. 중복 연산을 최소화한다.
2. 적정 정확도 수준을 결정한다. 꼭 필요하지 않다면 정확도를 일부 희생한다.
3. 가능하다면 공간 조인을 문자열 조인으로 대체한다.
```

이 글은 위 세 가지 접근법이 실제로 적용된 사례를 통해, 대규모 공간 데이터 처리 과정에서 계산 비용과 정확도 사이의 균형을 어떻게 찾아나갔는지 그 사고 과정을 공유하고자 한다. '정확도 조정' 파트가 포함되어 있어 모든 상황에 범용적으로 적용할 수는 없지만, 무엇을 포기하고 무엇을 얻는지에 대해 공유할만한 지점이 있다고 생각한다.

다음부터 이어질 사례는 Python 환경에서 Polars, Geopandas 등의 라이브러리를 활용했으나, 특정 기술 스택보다 문제 해결을 위한 사고 과정과 트레이드오프 결정에 초점을 맞추었다.

## 2. 대중교통 인접성 분석 사례

수억 건에 달하는 유저 위치 정보를 활용해 모든 유저에 대해 대중교통 인접성을 분석하는 상황을 가정해보자. 여기서 '대중교통 인접성'은 사용자의 위치로부터 500m 반경 내에 있는 버스 정류장의 수로 정의한다.

가장 직관적인 접근 방식은 아래와 같다.

```
1. 모든 사용자의 위치를 포인트 자료형으로 불러온다.
2. 모든 포인트에서 500m 버퍼를 생성한다.
3. 해당 버퍼 각각에 대해 포함된 정류장 수를 계산한다.
```

그러나 수억 포인트 이상의 위치 데이터에 대해 개별적으로 버퍼를 생성하고 정류장 데이터와 공간 조인을 수행하는 것은 현실적인 분석 시간을 초과할 가능성이 높다.

(물론 DuckDB의 공간 확장 기능 등을 사용한다면 웬만큼 큰 데이터도 그냥 다룰만하게 되지만(...) 그럼에도 불구하고 대규모 데이터셋에서는 기본적인 공간 연산 최적화 원칙은 여전히 중요하므로, 다음과 같은 대안적 접근법을 고려해볼 수 있다.)

우선 **중복 연산**을 살펴보면, 동일한 좌표값을 가진 유저에 대해 같은 연산을 반복하는 것이 명백한 중복이다. 더 나아가 인접한 유저의 대중교통 인접성이 실질적인 차이가 없는데도 같은 연산이 반복되는 것도 중복으로 볼 수 있다.

**적정 정확도 수준**에 대해서는, 정확한 500m 반경이 중요한 상황이라면 대표 샘플을 추출하는 등의 방법을 고려하여야겠지만, 정확한 반경 수치가 중요하지 않은 경우 선택지가 생긴다. 유저 정보를 개별 포인트가 아닌 특정 공간 영역(셀)으로 할당하는 양자화 방식을 적용할 수 있다. 충분히 작은 셀을 사용한다면 정확도 측면에서도 희생을 줄일 수 있으며, 정류장 데이터도 같은 방식으로 셀에 할당할 수 있다.

이러한 셀 기반 접근법의 핵심 장점은 X, Y 좌표값 대신 셀 ID를 사용함으로써 **공간 조인을 문자열 조인으로 대체**할 수 있다는 점이다. 공간 조인은 기하학적 연산을 기반으로 하기 때문에 계산 비용이 높지만, 문자열 조인은 단순 비교 연산만으로 수행되어 훨씬 효율적이다.

## 3. 분석 전략 수립
### 3.1. 포인트 양자화: H3 그리드 시스템
공간 데이터를 효율적으로 셀에 할당하기 위해 Uber에서 개발한 H3 그리드 시스템을 활용할 수 있다. H3는 지구 표면을 육각형 셀로 나누는 계층적 공간 인덱싱 시스템으로, 주요 장점은 다음과 같다:

1. 셀 간 면적 유사성으로 공간적 왜곡 최소화
2. 다양한 해상도를 지원하는 계층적 구조
3. 효율적인 이웃 셀 탐색 기능
4. 균일한 인접 셀 간 거리

### 3.2. H3의 grid_disk로 버퍼 대체

H3의 `grid_disk` 함수는 특정 셀을 중심으로 k단계까지의 이웃 셀을 찾아주는 기능으로, 육각형 구조의 특성상 결과는 원형에 가까운 형태를 띠게 된다. 이를 통해 기존의 원형 버퍼 연산을 효율적으로 대체할 수 있다.

실제 측정 결과, 해상도 9에서 우리나라의 단일 셀 평균 면적은 약 75,340m²로, 반지름 155m의 원과 유사하다. grid_disk 1을 사용해 한 바퀴 감싸면 총 면적은 527,379m²가 되어 반지름 410m의 원과 유사한 면적이 된다.

만약 500m 대신 410m 정도를 사용해도 문제가 없으며, 정류장 위치 데이터도 H3 셀로 양자화하면 연산은 극도로 단순해진다:

```
1. 모든 버스 정류장에 대해 H3 셀 ID 매핑
2. 각 셀 ID별 정류장 수를 계산
3. 사용자 위치를 H3 셀 ID로 매핑
4. grid_disk 함수로 이웃 셀 목록 생성
5. 해당 셀들에 포함된 정류장 수 합계 계산
```

이 방식에서 실제 공간 연산은 좌표-셀 변환 과정(1, 3단계)에서만 발생하며, 나머지는 문자열 기반 연산이나 단순 산술 연산으로 이루어진다. 특히 grid_disk 함수는 기하학적 계산 없이 H3의 내부 인덱싱 구조를 활용하여 매우 빠르게 수행된다.

## 4. 결론: 효율성과 정확도 사이의 균형

데이터 규모가 커질수록, 문제의 본질을 해치지 않는 선에서 적절한 근사치를 활용하는 것이 현실적인 선택이 될 수 있다. 본 글에서 소개한 그리드 시스템 접근법은 대용량 공간 데이터 처리에서 정확도와 성능 사이의 실용적인 타협점을 제시한다.

문제 정의와 요구사항에 대한 명확한 이해가 중요하다. "500m 내 정류장 수"라는 요구사항에서 "정확히 500m"가 필수적인지, 아니면 "대략 500m 정도"로 충분한지를 판단하는 것이 효율적인 해결책의 출발점이 된다. 대규모 공간 데이터 분석에서는 필요한 정확도와 허용 가능한 근사치의 경계를 명확히 설정하는 것이 종종 기술적 최적화보다 더 중요한 성공 요소가 될 수 있다.